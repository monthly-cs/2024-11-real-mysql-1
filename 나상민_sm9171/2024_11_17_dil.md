# 6. 데이터 압축
MySQL 서버에서 사용 가능한 압축 방식은 크게 테이블 압축과 페이지 압축의 두 가지 종류로 구분할 수 있다.

## 페이지 압축
- 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 펀치 홀이라는 기능을 사용한다.
- MySQL 서버의 페이지 압축이 가진 문제는 펀치 홀 기능은 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능하다는 점이다.
- 또 다른 문제점은 아직 파일 시스템 관련 명령어가 펀치 홀을 지원하지 못하다는 것이다.
- 이런 이유로 실제 페이지 압축은 많이 사용되지 않는 상태다.

## 테이블 압축
- 테이블 압축은 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 일반적으로 더 활용도가 높은 편이다.
- 디스크의 데이터 파일 크기를 줄일 수 있지만 다음과 같은 몇 가지 단점이 있다.
  - 버퍼 풀 공간 활용률이 낮음
  - 쿼리 처리 성능이 낮음
  - 빈번한 데이터 변경 시 압축률이 낮음

### 압축 테이블 생성
- 테이블의 압축 방식은 원본 데이터 페이지의 압축 결과가 목표 크기(KEY_BLOCK_SIZE)보다 작거나 같을 때까지 반복해서 페이지를 스플릿한다.

### KEY_BLOCK_SIZE 결정
- 처음에 KEY_BLOCK_SIZE를 4KB 또는 8KB로 테이블을 생성해서 샘플 데이터를 저장해보고 적절한지 판단하는 것이 좋다.
- 압축 실패율이 높더라도 전체적으로 데이터 파일의 크기가 큰 폭으로 줄어들면 손해는 아니다.
- 테이블 압축은 zlib을 이용하여 압축을 실행하는데 zlib 압축 알고리즘은 CPU자원이 많이 소모되기 때문에, 매우 빈번하게 조회되고 변경된다면 압축을 고려하지 않는 것이 좋다.

### 압축된 페이지의 버퍼 풀 적재 및 사용
- MySQL 서버에는 압축된 테이블과 압축되지 않은 테이블이 공존하여 결국 LRU 리스트에는 두 페이지 모두 갖는다.
- InnoDB 스토리지 엔진은 버퍼 풀에서 압축 해제된 버전의 데이터 페이지를 적절한 수준으로 유지하기 위해 다음과 같은 어댑티브 알고리즘을 사용한다.
  - CPU 사용량이 높은 서버에서는 가능하면 압축과 압축 해제를 피하기 위해 Unzip_LRU의 비율을 높여서 유지하고
  - Disk IO 사용량이 높은 서버에서는 가능하면 Unzip_LRU 리스트의 비율을 낮춰서 InnoDB 버퍼 풀의 공간을 더 확보하도록 작동한다.
