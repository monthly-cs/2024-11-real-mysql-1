# 5. 트랜잭션과 잠금
잠금은 동시성을 제어하기 위한 기능이고 트랜잭션은 데이터의 정합성을 보장하기 위한 기능이다.
## MySQL 엔진의 잠금
MySQL에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 잇다.
MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 해당 스토리지 엔진에만 영향을 미친다.
MySQL 엔진에서는 테이블 데이터 동기화를 위한 테이블 락 이외에도 테이블의 구조를 잠그는 메타데이터 락 그리고 사용자의 필요에 맞게 사용할 수 있는 네임드 락이라는 잠금 기능도 제공한다.

### 글로벌 락
- `FLUSH TABLES WITH READ LOCK` 명령은 실행과 동시에 MySQL 서버에 존재하는 모든 테이블을 닫고 잠금을 건다.
- MySQL 8.0버전부터는 Xtrabackup이나 Enterprise Backup과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입됐다.
- 백업락은 일반적인 테이블의 변경은 허용 되지만 다음과 같이 테이블의 스키마나 사용자의 인증 관련 정보를 변경할 수 없게 된다.
  - 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
  - REPAIR TABLE과 OPTIMIZE TABLE 명령
  - 사용자 관리 및 비밀번호 변경
### 테이블 락
- 'LOCK TABLES table_name [READ | WRITE]' 명령을 사용하여 명시적으로 테이블 레벨의 락을 걸 수 있다.
- 명시적으로 획득한 잠금은 UNLOCK TABLES 명령을 사용하여 잠금을 반납할 수 있다.
- InnoDB 테이블의 경우 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에 단순 데이터 변경 쿼리로 인해 묵시적인 테이블 락이 설정되지는 않는다.

### 네임드 락
- 네임드 락은 `GET_LOCK()` 함수를 사용하여 임의의 문자열에 대해 잠금을 설정할 수 있다.
- 네임드 락의 경우 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하다.

### 메타데이터 락
- 메타데이터 락은 데이터베이스 객체의 이름이나 구조를 변경하는 경우에 획득하는 잠금이다.
- 만약 `RENAME TABGLE tab_a TO tab_b` 명령을 실행하면 tab_a와 tab_b 테이블에 대한 메타데이터 락이 설정된다.

## InnoDB 엔진의 잠금
- InnoDB 엔진은 레코드 기반의 잠금 기능을 제공하며, 잠금 정보가 상당히 작은 공간으로 관리되기 때문에 레코드 락이 페이지 락으로 레벨업되는(락 에스컬레이션) 경우는 없다.
  ![image](https://github.com/user-attachments/assets/bb6b20d4-8823-48d3-9a21-98bbfb3ebb0a)
### 레코드 락
- 레코드 자체만을 잠그는 것을 레코드 락이라고 하며, 다른 상용 DBMS의 레코드 락과 동일한 역할을 한다.
- 한 가지 중요한 차이는 InnoDB 스토리지 엔진은 레코드 자체가 아니라 인덱스의 레코드를 잠근다는 점이다.
### 갭 락
- 다른 DBMS에는 없는 개념으로, 레코드 자체가 아니라 레코드와 바로 인접한 레코드 사이의 간격만을 잠그는 것을 의미한다.
- 갭 락의 역할은 레코드와 레코드 사이의 간격에 새로운 레코드가 생성되는 것을 제어하는 것이다.
- 갭 락은 그 자체보다는 넥스트 키 락의 일부로 자주 사용된다.

### 넥스트키 락
- 레코드락과 갭 락을 합쳐 놓은 형태의 잠금을 넥스트 키락이라고 한다.
- InnoDB의 갭 락이나 넥스트 키 락은 바이너리 로그에 기록되는 쿼리가 레플리카 서버에서 실행될 때 소스 서버에서 만들어 낸 결과와 동일한 결과를 만들어내도록 보장하는 것이 주목적이다.
- 그런데 의외로 넥스트 키 락과 갭 락으로 인해 데드락이 발생하거나 다른 트랜잭션을 기다리게 만드는 일이 자주 발생해서 가능하다면 바이너리 로그 포맷을 ROW 형태로 바꿔서 넥스트 키 락이나 갭 락을 줄이는 것이 좋다.

### 자동 증가 락
- MySQL에서는 자동 증가하는 숫자 값을 추출하기 위해 `AUTO_INCREMENT`라는 칼럼 속성을 제공한다.
- `AUTO_INCREMENT`칼럼이 사용된 테이블에 동시에 여러 레코드가 INSERT되는 경우, 저장되는 각 레코드는 중복되지 않고 저장된 순서대로 증가하는 일련번호 값을 가져야 한다.
- InnoDB 스토리지 엔진에서는 이를 위해 내부적으로 `AUTO_INCREMENT` 락이라고 하는 테이블 수준의 잠금을 사용한다.
- MySQL 5.1이상부터는 `innodb_autoinc_lock_mode`라는 시스템 변수를 이용해 자동 증가 락의 작동 방식을 변경할 수 있다.

### 인덱스와 잠금
- InnoDB 스토리지 엔진은 레코드 레벨의 잠금을 사용하기 때문에 인덱스의 레코드를 잠그게 된다. 즉, 변경해야 할 레코드를 찾기 위해 검색한 인덱스의 레코드를 모두 락을 걸어야 한다.

## MySQL의 격리 수준
### READ UNCOMMITTED
### READ COMMITTED
### REPEATABLE READ
### SERIALIZABLE
